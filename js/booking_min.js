function showSuccessMessage(e,t=3e3){let n=document.createElement("div");n.textContent=e,Object.assign(n.style,{position:"fixed",bottom:"20px",left:"50%",transform:"translateX(-50%)",background:"#28a745",color:"#fff",padding:"12px 20px",borderRadius:"8px",fontWeight:"bold",boxShadow:"0 2px 10px rgba(0,0,0,0.3)",zIndex:"9999",transition:"opacity 0.3s ease-in-out",opacity:"1"}),document.body.appendChild(n),setTimeout(()=>{n.style.opacity="0",setTimeout(()=>n.remove(),300)},t)}function showErrorMessage(e,t=4e3){let n=document.createElement("div");n.textContent=e,Object.assign(n.style,{position:"fixed",bottom:"20px",left:"50%",transform:"translateX(-50%)",background:"#dc3545",color:"#fff",padding:"12px 20px",borderRadius:"8px",fontWeight:"bold",boxShadow:"0 2px 10px rgba(0,0,0,0.3)",zIndex:"9999",transition:"opacity 0.3s ease-in-out",opacity:"1"}),document.body.appendChild(n),setTimeout(()=>{n.style.opacity="0",setTimeout(()=>n.remove(),300)},t)}async function updateLivePrice(){let e=document.getElementById("bikeType"),t=document.getElementById("duration"),n=document.getElementById("quantity"),l=document.getElementById("tourSelected"),o=document.getElementById("eventIdHidden"),a=document.getElementById("paypalPlaceholder"),i=document.getElementById("ownBikeCheckbox")?.checked,r=i?"NESSUNA":e?e.value:"",d=t?parseFloat(t.value):0,s=n?parseInt(n.value||"1"):1,c=l?l.value.trim():null,u=o?o.value.trim():null;if(!r||isNaN(d)||d<=0||isNaN(s)||s<=0){document.getElementById("totalAmount").textContent="0.00",document.getElementById("totalHidden").value="0.00",a&&(a.innerHTML="",a.style.display="none"),window.prezzoRisposta=null;return}let p={tipo:r,giorni:d,quantita:s},y=Array.from(document.querySelectorAll("input[name='accessories']:checked")).map(e=>e.value);y.length>0&&(p.accessories=y),c?(p.tour=c,p.eventoId=null):u&&(p.eventoId=u,p.tour=null);try{let m=await fetch("https://price-calculator.zonkeynet.workers.dev/calcola",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)}),g=await m.json();m.ok&&"success"===g.status?(document.getElementById("totalAmount").textContent=g.totale,document.getElementById("totalHidden").value=g.totale,window.prezzoRisposta=g):(showErrorMessage(`Errore nel calcolo del prezzo: ${g.message||"Errore sconosciuto."}`),document.getElementById("totalAmount").textContent="0.00",document.getElementById("totalHidden").value="0.00",a&&(a.innerHTML="",a.style.display="none"),window.prezzoRisposta=null)}catch(v){console.error("❌ Errore durante il calcolo del prezzo:",v.message),showErrorMessage(`Impossibile calcolare il prezzo: ${v.message}`),document.getElementById("totalAmount").textContent="0.00",document.getElementById("totalHidden").value="0.00",a&&(a.innerHTML="",a.style.display="none"),window.prezzoRisposta=null}}function getInputValue(e){let t=document.getElementById(e);return t?(t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),t.value.trim()):""}function validateField(e){if(!e)return;let t=e.closest(".form-group");if(t)return""===e.value.trim()?(t.classList.add("error"),!1):(t.classList.remove("error"),!0)}function initializeBookingForm(){document.getElementById("bikeType")?.addEventListener("change",updateLivePrice),document.getElementById("duration")?.addEventListener("change",updateLivePrice),document.getElementById("quantity")?.addEventListener("input",updateLivePrice),Array.from(document.querySelectorAll("input[name='accessories']:checked")).map(e=>e.value),document.getElementById("name")?.addEventListener("input",e=>validateField(e.target)),document.getElementById("email")?.addEventListener("input",e=>validateField(e.target)),document.getElementById("date")?.addEventListener("input",e=>validateField(e.target)),document.querySelectorAll(".bike-select").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();let n=e.getAttribute("data-bike"),l=document.getElementById("bikeType");l&&(l.value=n,showSuccessMessage(`🚲 ${n} selezionata!`,2e3)),document.getElementById("accessoriesGroup").style.display="block",updateLivePrice(),document.getElementById("noleggio")?.scrollIntoView({behavior:"smooth",block:"start"})})}),document.querySelectorAll("input[name='accessories']").forEach(e=>{e.addEventListener("change",updateLivePrice)}),document.getElementById("bikeType")?.addEventListener("change",e=>{let t=e.target.value,n=document.getElementById("accessoriesGroup");t&&"NESSUNA"!==t?n.style.display="block":n.style.display="none",updateLivePrice()}),document.body.addEventListener("click",e=>{let t=e.target.closest(".tour-book");if(!t)return;e.preventDefault();let n=t.getAttribute("data-tour-id"),l=t.getAttribute("data-tour-name"),o=document.getElementById("tourSelected"),a=document.getElementById("tourField"),i=document.getElementById("eventSelected"),r=document.getElementById("eventIdHidden"),d=document.getElementById("eventField");o&&a&&(o.value=l,o.setAttribute("data-tour-id",n),a.style.display="flex",i&&d&&r&&(i.value="",r.value="",d.style.display="none"),updateLivePrice(),document.getElementById("noleggio")?.scrollIntoView({behavior:"smooth",block:"start"}))});let e=document.querySelector(".tour-input-wrapper");if(e&&!document.getElementById("removeTourBtn")){let t=document.createElement("button");t.type="button",t.id="removeTourBtn",t.innerHTML="✖",t.title="Rimuovi tour selezionato",Object.assign(t.style,{marginLeft:"10px",background:"none",border:"none",fontSize:"1.3rem",cursor:"pointer",color:"#dc3545"}),t.addEventListener("click",()=>{let e=document.getElementById("tourSelected"),t=document.getElementById("tourField");e&&t&&(e.value="",e.removeAttribute("data-tour-id"),t.style.display="none",showSuccessMessage("❌ Tour rimosso!",2500),updateLivePrice())}),e.appendChild(t)}document.getElementById("eventIdHidden")?.addEventListener("change",e=>{let t=e.target.value,n=document.getElementById("eventSelected"),l=document.getElementById("eventField"),o=document.getElementById("tourSelected"),a=document.getElementById("tourField");t?(n&&l&&(l.style.display="flex"),o&&a&&(o.value="",o.removeAttribute("data-tour-id"),a.style.display="none"),updateLivePrice()):(n&&l&&(n.value="",l.style.display="none"),updateLivePrice())});let n=document.querySelector(".event-input-wrapper");if(n&&!document.getElementById("removeEventBtn")){let l=document.createElement("button");l.type="button",l.id="removeEventBtn",l.innerHTML="✖",l.title="Rimuovi evento selezionato",Object.assign(l.style,{marginLeft:"10px",background:"none",border:"none",fontSize:"1.3rem",cursor:"pointer",color:"#dc3545"}),l.addEventListener("click",()=>{let e=document.getElementById("eventSelected"),t=document.getElementById("eventIdHidden"),n=document.getElementById("eventField");e&&t&&n&&(e.value="",t.value="",n.style.display="none",showSuccessMessage("❌ Evento rimosso!",2500),updateLivePrice())}),n.appendChild(l)}document.querySelectorAll(".bike-select").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();let n=e.getAttribute("data-bike"),l=document.getElementById("bikeType");l&&(l.value=n,updateLivePrice(),showSuccessMessage(`🚲 ${n} selezionata!`,2e3),document.getElementById("noleggio")?.scrollIntoView({behavior:"smooth",block:"start"}))})});let o=document.getElementById("noleggioForm");if(!o){console.error("❌ Form #noleggioForm non trovato!");return}o.addEventListener("submit",async e=>{e.preventDefault();let t=document.getElementById("responseMessage"),n=hcaptcha.getResponse();if(!n){showErrorMessage("⚠️ Devi completare il captcha."),t.textContent="❌ Verifica il captcha prima di inviare.",t.style.color="#dc3545";return}t.textContent="⏳ Invio richiesta in corso...",t.style.color="#000",document.querySelectorAll(".form-group.error").forEach(e=>e.classList.remove("error"));let l=getInputValue("name"),a=getInputValue("email"),i=document.getElementById("ownBikeCheckbox")?.checked,r=i?"NESSUNA":getInputValue("bikeType"),d=getInputValue("quantity")||"1",s=getInputValue("date"),c=getInputValue("duration")||"1",u=getInputValue("notes"),p=getInputValue("tourSelected"),y=getInputValue("eventIdHidden"),m=getInputValue("eventSelected"),g=getInputValue("totalHidden")||"0.00",v=!1,E=[{id:"name",value:l,label:"Nome e Cognome"},{id:"email",value:a,label:"Email"},{id:"bikeType",value:i?"NESSUNA":r,label:"Tipo di bici"},{id:"date",value:s,label:"Data"}],I=[];if(E.forEach(e=>{e.value||(validateField(document.getElementById(e.id)),v=!0,I.push(e.label))}),v){t.textContent=`❌ Errore: Compila tutti i campi obbligatori evidenziati. Mancanti: ${I.join(", ")}.`,t.style.color="#dc3545",showErrorMessage("Completa tutti i campi richiesti.");let $=document.getElementById(E.find(e=>!e.value)?.id);$&&$.focus();return}let b=new FormData;b.set("name",l),b.set("email",a),b.set("bikeType",r),b.set("quantity",d),b.set("date",s),b.set("duration",c),b.set("notes",u),b.set("tourSelected",p),b.set("eventSelected",m),b.set("eventIdHidden",y),b.set("total",g);let B=Array.from(document.querySelectorAll("input[name='accessories']:checked")).map(e=>e.value);b.set("accessories",B.join(", ")),b.set("hcaptchaToken",n);try{let h=await fetch("https://workers-bibbonabike.zonkeynet.workers.dev/submit",{method:"POST",body:b}),f=await h.json();if(h.ok&&"success"===f.status){t.textContent="✅ Prenotazione inviata con successo!",t.style.color="#28a745",o.querySelectorAll("input, textarea, select").forEach(e=>{["bikeType","duration","quantity","notes","name","email","date"].includes(e.id)&&(e.value="")});let k=document.getElementById("paypalPlaceholder");if(window.prezzoRisposta?.paypalHtml&&k){k.innerHTML=window.prezzoRisposta.paypalHtml,k.style.display="block";let L=document.createElement("p");L.textContent="Per completare la prenotazione, procedi al pagamento tramite PayPal:",Object.assign(L.style,{marginTop:"15px",marginBottom:"10px",color:"#333",fontWeight:"bold",textAlign:"center"}),k.prepend(L)}document.getElementById("totalAmount").textContent="0.00",document.getElementById("totalHidden").value="0.00",document.getElementById("tourSelected").value="",document.getElementById("tourSelected")?.removeAttribute("data-tour-id"),document.getElementById("tourField").style.display="none",document.getElementById("eventSelected").value="",document.getElementById("eventIdHidden").value="",document.getElementById("eventField").style.display="none",showSuccessMessage("✅ Prenotazione completata!",4e3)}else{let S=f.message||"Qualcosa \xe8 andato storto sul server.";t.textContent=`❌ Errore: ${S}`,t.style.color="#dc3545",showErrorMessage(`Errore di invio: ${S}`);let x=document.getElementById("paypalPlaceholder");x&&(x.innerHTML="",x.style.display="none")}}catch(w){t.textContent="❌ Errore di rete o problema di risposta del server.",t.style.color="#dc3545",console.error("❌ Errore di invio del form (blocco catch):",w),showErrorMessage("Errore di connessione. Controlla la tua rete.")}}),updateLivePrice()}document.addEventListener("DOMContentLoaded",initializeBookingForm),document.getElementById("ownBikeCheckbox")?.addEventListener("change",e=>{let t=e.target.checked,n=document.getElementById("bikeType"),l=document.getElementById("quantity");t?(n.disabled=!0,l.disabled=!0):(n.disabled=!1,l.disabled=!1),updateLivePrice()});