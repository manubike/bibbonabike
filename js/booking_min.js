function showSuccessMessage(message,duration=3e3){const msg=document.createElement("div");msg.textContent=message;Object.assign(msg.style,{position:"fixed",bottom:"20px",left:"50%",transform:"translateX(-50%)",background:"#28a745",color:"#fff",padding:"12px 20px",borderRadius:"8px",fontWeight:"bold",boxShadow:"0 2px 10px rgba(0,0,0,0.3)",zIndex:"9999",transition:"opacity 0.3s ease-in-out",opacity:"1"});document.body.appendChild(msg);setTimeout(()=>{msg.style.opacity="0";setTimeout(()=>msg.remove(),300)},duration)}function showErrorMessage(message,duration=4e3){const msg=document.createElement("div");msg.textContent=message;Object.assign(msg.style,{position:"fixed",bottom:"20px",left:"50%",transform:"translateX(-50%)",background:"#dc3545",color:"#fff",padding:"12px 20px",borderRadius:"8px",fontWeight:"bold",boxShadow:"0 2px 10px rgba(0,0,0,0.3)",zIndex:"9999",transition:"opacity 0.3s ease-in-out",opacity:"1"});document.body.appendChild(msg);setTimeout(()=>{msg.style.opacity="0";setTimeout(()=>msg.remove(),300)},duration)}async function updateLivePrice(){const bikeTypeElement=document.getElementById("bikeType");const durationElement=document.getElementById("duration");const quantityElement=document.getElementById("quantity");const tourInputElement=document.getElementById("tourSelected");const eventIdHiddenElement=document.getElementById("eventIdHidden");const paypalPlaceholder=document.getElementById("paypalPlaceholder");const ownBike=document.getElementById("ownBikeCheckbox")?.checked;const bikeType=ownBike?"NESSUNA":bikeTypeElement?bikeTypeElement.value:"";const duration=durationElement?parseFloat(durationElement.value):0;const quantity=quantityElement?parseInt(quantityElement.value||"1"):1;const tour=tourInputElement?tourInputElement.value.trim():null;const eventId=eventIdHiddenElement?eventIdHiddenElement.value.trim():null;if(!bikeType||isNaN(duration)||duration<=0||isNaN(quantity)||quantity<=0){console.warn("⚠️ Tipo di bici, durata o quantità non validi per il calcolo del prezzo.");document.getElementById("totalAmount").textContent="0.00";document.getElementById("totalHidden").value="0.00";if(paypalPlaceholder){paypalPlaceholder.innerHTML="";paypalPlaceholder.style.display="none"}window.prezzoRisposta=null;return}const data={tipo:bikeType,giorni:duration,quantita:quantity};if(tour){data.tour=tour;data.eventoId=null}else if(eventId){data.eventoId=eventId;data.tour=null}try{const response=await fetch("https://price-calculator.zonkeynet.workers.dev/calcola",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});const result=await response.json();if(response.ok&&result.status==="success"){document.getElementById("totalAmount").textContent=result.totale;document.getElementById("totalHidden").value=result.totale;window.prezzoRisposta=result}else{showErrorMessage(`Errore nel calcolo del prezzo: ${result.message||"Errore sconosciuto."}`);document.getElementById("totalAmount").textContent="0.00";document.getElementById("totalHidden").value="0.00";if(paypalPlaceholder){paypalPlaceholder.innerHTML="";paypalPlaceholder.style.display="none"}window.prezzoRisposta=null}}catch(error){console.error("❌ Errore durante il calcolo del prezzo:",error.message);showErrorMessage(`Impossibile calcolare il prezzo: ${error.message}`);document.getElementById("totalAmount").textContent="0.00";document.getElementById("totalHidden").value="0.00";if(paypalPlaceholder){paypalPlaceholder.innerHTML="";paypalPlaceholder.style.display="none"}window.prezzoRisposta=null}}function getInputValue(id){const el=document.getElementById(id);if(el){el.dispatchEvent(new Event("input",{bubbles:true}));el.dispatchEvent(new Event("change",{bubbles:true}));return el.value.trim()}return""}function validateField(element){if(!element)return;const formGroup=element.closest(".form-group");if(!formGroup)return;if(element.value.trim()===""){formGroup.classList.add("error");return false}else{formGroup.classList.remove("error");return true}}function initializeBookingForm(){document.getElementById("bikeType")?.addEventListener("change",updateLivePrice);document.getElementById("duration")?.addEventListener("change",updateLivePrice);document.getElementById("quantity")?.addEventListener("input",updateLivePrice);document.getElementById("name")?.addEventListener("input",e=>validateField(e.target));document.getElementById("email")?.addEventListener("input",e=>validateField(e.target));document.getElementById("date")?.addEventListener("input",e=>validateField(e.target));document.body.addEventListener("click",e=>{const btn=e.target.closest(".tour-book");if(!btn)return;e.preventDefault();const tourId=btn.getAttribute("data-tour-id");const tourName=btn.getAttribute("data-tour-name");const tourInput=document.getElementById("tourSelected");const tourField=document.getElementById("tourField");const eventInput=document.getElementById("eventSelected");const eventIdHidden=document.getElementById("eventIdHidden");const eventField=document.getElementById("eventField");if(tourInput&&tourField){tourInput.value=tourName;tourInput.setAttribute("data-tour-id",tourId);tourField.style.display="flex";if(eventInput&&eventField&&eventIdHidden){eventInput.value="";eventIdHidden.value="";eventField.style.display="none"}showSuccessMessage(`✅ Tour "${tourName}" aggiunto!`);updateLivePrice();document.getElementById("noleggio")?.scrollIntoView({behavior:"smooth",block:"start"})}});const tourInputWrapper=document.querySelector(".tour-input-wrapper");if(tourInputWrapper&&!document.getElementById("removeTourBtn")){const removeBtn=document.createElement("button");removeBtn.type="button";removeBtn.id="removeTourBtn";removeBtn.innerHTML="✖";removeBtn.title="Rimuovi tour selezionato";Object.assign(removeBtn.style,{marginLeft:"10px",background:"none",border:"none",fontSize:"1.3rem",cursor:"pointer",color:"#dc3545"});removeBtn.addEventListener("click",()=>{const input=document.getElementById("tourSelected");const field=document.getElementById("tourField");if(input&&field){input.value="";input.removeAttribute("data-tour-id");field.style.display="none";showSuccessMessage("❌ Tour rimosso!",2500);updateLivePrice()}});tourInputWrapper.appendChild(removeBtn)}document.getElementById("eventIdHidden")?.addEventListener("change",e=>{const eventId=e.target.value;const eventInput=document.getElementById("eventSelected");const eventField=document.getElementById("eventField");const tourInput=document.getElementById("tourSelected");const tourField=document.getElementById("tourField");if(eventId){if(eventInput&&eventField){eventField.style.display="flex"}if(tourInput&&tourField){tourInput.value="";tourInput.removeAttribute("data-tour-id");tourField.style.display="none"}updateLivePrice()}else{if(eventInput&&eventField){eventInput.value="";eventField.style.display="none"}updateLivePrice()}});const eventInputWrapper=document.querySelector(".event-input-wrapper");if(eventInputWrapper&&!document.getElementById("removeEventBtn")){const removeBtn=document.createElement("button");removeBtn.type="button";removeBtn.id="removeEventBtn";removeBtn.innerHTML="✖";removeBtn.title="Rimuovi evento selezionato";Object.assign(removeBtn.style,{marginLeft:"10px",background:"none",border:"none",fontSize:"1.3rem",cursor:"pointer",color:"#dc3545"});removeBtn.addEventListener("click",()=>{const input=document.getElementById("eventSelected");const idHidden=document.getElementById("eventIdHidden");const field=document.getElementById("eventField");if(input&&idHidden&&field){input.value="";idHidden.value="";field.style.display="none";showSuccessMessage("❌ Evento rimosso!",2500);updateLivePrice()}});eventInputWrapper.appendChild(removeBtn)}document.querySelectorAll(".bike-select").forEach(btn=>{btn.addEventListener("click",e=>{e.preventDefault();const bikeType=btn.getAttribute("data-bike");const selectElement=document.getElementById("bikeType");if(selectElement){selectElement.value=bikeType;updateLivePrice();showSuccessMessage(`🚲 ${bikeType} selezionata!`,2e3);document.getElementById("noleggio")?.scrollIntoView({behavior:"smooth",block:"start"})}})});const rentalForm=document.getElementById("noleggioForm");if(!rentalForm){console.error("❌ Form #noleggioForm non trovato!");return}rentalForm.addEventListener("submit",async e=>{e.preventDefault();const responseMessage=document.getElementById("responseMessage");responseMessage.textContent="⏳ Invio richiesta in corso...";responseMessage.style.color="#000";document.querySelectorAll(".form-group.error").forEach(el=>el.classList.remove("error"));const name=getInputValue("name");const email=getInputValue("email");const ownBike=document.getElementById("ownBikeCheckbox")?.checked;const bikeType=ownBike?"NESSUNA":getInputValue("bikeType");const quantity=getInputValue("quantity")||"1";const date=getInputValue("date");const duration=getInputValue("duration")||"1";const notes=getInputValue("notes");const tourSelected=getInputValue("tourSelected");const eventIdHidden=getInputValue("eventIdHidden");const eventSelected=getInputValue("eventSelected");const total=getInputValue("totalHidden")||"0.00";let hasMissingFields=false;const requiredFields=[{id:"name",value:name,label:"Nome e Cognome"},{id:"email",value:email,label:"Email"},{id:"bikeType",value:ownBike?"NESSUNA":bikeType,label:"Tipo di bici"},{id:"date",value:date,label:"Data"}];let missingLabels=[];requiredFields.forEach(field=>{if(!field.value){validateField(document.getElementById(field.id));hasMissingFields=true;missingLabels.push(field.label)}});if(hasMissingFields){responseMessage.textContent=`❌ Errore: Compila tutti i campi obbligatori evidenziati. Mancanti: ${missingLabels.join(", ")}.`;responseMessage.style.color="#dc3545";showErrorMessage("Completa tutti i campi richiesti.");const firstMissingField=document.getElementById(requiredFields.find(f=>!f.value)?.id);if(firstMissingField)firstMissingField.focus();return}const formData=new FormData;formData.set("name",name);formData.set("email",email);formData.set("bikeType",bikeType);formData.set("quantity",quantity);formData.set("date",date);formData.set("duration",duration);formData.set("notes",notes);formData.set("tourSelected",tourSelected);formData.set("eventSelected",eventSelected);formData.set("eventIdHidden",eventIdHidden);formData.set("total",total);try{const response=await fetch("https://workers-bibbonabike.zonkeynet.workers.dev/submit",{method:"POST",body:formData});const result=await response.json();if(response.ok&&result.status==="success"){responseMessage.textContent="✅ Prenotazione inviata con successo!";responseMessage.style.color="#28a745";rentalForm.querySelectorAll("input, textarea, select").forEach(el=>{if(["bikeType","duration","quantity","notes","name","email","date"].includes(el.id)){el.value=""}});const paypalPlaceholder=document.getElementById("paypalPlaceholder");if(window.prezzoRisposta?.paypalHtml){if(paypalPlaceholder){paypalPlaceholder.innerHTML=window.prezzoRisposta.paypalHtml;paypalPlaceholder.style.display="block";const paymentInstruction=document.createElement("p");paymentInstruction.textContent="Per completare la prenotazione, procedi al pagamento tramite PayPal:";Object.assign(paymentInstruction.style,{marginTop:"15px",marginBottom:"10px",color:"#333",fontWeight:"bold",textAlign:"center"});paypalPlaceholder.prepend(paymentInstruction)}}document.getElementById("totalAmount").textContent="0.00";document.getElementById("totalHidden").value="0.00";document.getElementById("tourSelected").value="";document.getElementById("tourSelected")?.removeAttribute("data-tour-id");document.getElementById("tourField").style.display="none";document.getElementById("eventSelected").value="";document.getElementById("eventIdHidden").value="";document.getElementById("eventField").style.display="none";showSuccessMessage("✅ Prenotazione completata!",4e3)}else{const errorMessage=result.message||"Qualcosa è andato storto sul server.";responseMessage.textContent=`❌ Errore: ${errorMessage}`;responseMessage.style.color="#dc3545";showErrorMessage(`Errore di invio: ${errorMessage}`);const paypalPlaceholder=document.getElementById("paypalPlaceholder");if(paypalPlaceholder){paypalPlaceholder.innerHTML="";paypalPlaceholder.style.display="none"}}}catch(error){responseMessage.textContent="❌ Errore di rete o problema di risposta del server.";responseMessage.style.color="#dc3545";console.error("❌ Errore di invio del form (blocco catch):",error);showErrorMessage("Errore di connessione. Controlla la tua rete.")}});updateLivePrice()}document.addEventListener("DOMContentLoaded",initializeBookingForm);document.getElementById("ownBikeCheckbox")?.addEventListener("change",e=>{const isChecked=e.target.checked;const bikeTypeSelect=document.getElementById("bikeType");const quantityInput=document.getElementById("quantity");if(isChecked){bikeTypeSelect.disabled=true;quantityInput.disabled=true}else{bikeTypeSelect.disabled=false;quantityInput.disabled=false}updateLivePrice()});